name: Release

on:
  push:
    tags:
      - '*'

permissions:
  contents: write
  id-token: write

env:
  CARGO_TERM_COLOR: always
  CUDA_COMPUTE_CAP: 75

jobs:
  build-windows-web:
    name: Windows Web
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6
      - uses: Jimver/cuda-toolkit@master
        with:
          cuda: '12.9.1'
          method: 'network'
          sub-packages: '["cudart", "cublas", "cufft", "nvcc"]'
      - uses: ilammy/msvc-dev-cmd@v1
      - name: Build koharu-web with CUDA
        run: cargo build --release -p koharu-web --features=cuda,cudnn
      - name: Prepare distribution folder
        shell: bash
        run: |
          mkdir dist
          cp target/release/koharu-web.exe dist/
      - name: Package and upload to Release
        shell: bash
        run: |
          dotnet tool update -g vpk
          vpk pack -u Koharu -v ${{ github.ref_name }} -p dist -e koharu-web.exe -i koharu/icons/icon.ico
          vpk upload github \
            --repoUrl https://github.com/${{ github.repository }} \
            --releaseName ${{ github.ref_name }} \
            --tag ${{ github.ref_name }} \
            --token ${{ secrets.GITHUB_TOKEN }} \
            --merge
      - name: Prepare bundled artifacts
        shell: bash
        run: |
          mkdir -p bundled-artifacts
          cp target/release/koharu-web.exe bundled-artifacts/
          touch bundled-artifacts/.portable
          cd bundled-artifacts
          ./koharu-web.exe -d
          echo "Creating CUDA bundled archive..."
          7z a ../Releases/Koharu-web-win-CUDA-Bundled.7z -x!models/*/blobs '-x!*.log' * .portable
      - name: Upload Bundled Artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: Releases/Koharu-web-win-CUDA-Bundled.7z
          make_latest: false
        env:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload koharu-web.exe as artifact
        uses: actions/upload-artifact@v4
        with:
          name: koharu-web-cuda
          path: target/release/koharu-web.exe